{{ define "content" }}
<section class="hero py-4">
    <div class="hero-body">
        <div class="container">
            <h1 class="title is-3">Device ID: {{ .Device.ID }}</h1>
            <h2 class="subtitle is-5">Location: {{ .Device.Location }}</h2>
        </div>
    </div>
</section>

<div class="container mt-5">
    <div class="card">
        <header class="card-header">
            <p class="card-header-title">Device Details</p>
        </header>
        <div class="card-content">
            <div class="content">
                <div class="columns is-multiline">
                    <div class="column is-half">
                        <p><strong>Created At:</strong> {{ .Device.CreatedAt }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="mt-4">
        <a hx-get="/devices" hx-target="#main-content" hx-push-url="true" class="button is-link">
            ‚Üê Back to Devices
        </a>
    </div>
</div>

<form>
    <div class="field is-grouped is-grouped-centered">
        <div class="field">
            <label for="measurement-begin" class="label">Begin</label>
            <input class="input" type="datetime-local" id="measurement-begin" name="begin" />
        </div>
        <div class="field">
            <label for="measurement-end" class="label">End</label>
            <input class="input" type="datetime-local" id="measurement-end" name="end" />
        </div>
    </div>
</form>

<div id="iot-chart"></div>

<script>
    const deviceID = "{{ .Device.ID }}";
    const beginInput = document.getElementById("measurement-begin");
    const endInput = document.getElementById("measurement-end");

    function toLocalInputString(date) {
        const z = n => String(n).padStart(2, "0");
        return date.getFullYear()
            + "-" + z(date.getMonth() + 1)
            + "-" + z(date.getDate())
            + "T" + z(date.getHours())
            + ":" + z(date.getMinutes());
    }

    document.addEventListener("DOMContentLoaded", () => {
        const now = new Date();
        const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
        beginInput.value = toLocalInputString(oneHourAgo);
        endInput.value = toLocalInputString(now);

        // initial draw
        loadChart(deviceID, beginInput.value, endInput.value);
    });

    [beginInput, endInput].forEach(input => {
        input.addEventListener("change", () => {
            if (beginInput.value && endInput.value) {
                loadChart(deviceID, beginInput.value, endInput.value);
            }
        });
    });

    async function loadChart(deviceID, beginLocal, endLocal) {
        const beginRFC = new Date(beginLocal).toISOString().replace(/\.\d{3}Z$/, "Z");
        const endRFC = new Date(endLocal).toISOString().replace(/\.\d{3}Z$/, "Z");

        const params = new URLSearchParams({ begin: beginRFC, end: endRFC });

        console.log("Requesting:", `/api/devices/${deviceID}/measurements?${params}`);
        const resp = await fetch(`/api/devices/${deviceID}/measurements?${params}`);
        if (!resp.ok) throw new Error(resp.statusText);

        const measurements = await resp.json();

        console.log("Measurements data  points:", measurements.length);
        const times = measurements.map(m => new Date(m.timestamp).getTime() / 1000);
        const vals = measurements.map(m => m.value);

        opts = {
            title: `Device ${deviceID}`,
            width: 800, height: 600,
            scales: { x: { time: true }, y: { auto: true } },
            series: [
                { label: "Time" },
                {
                    show: true,
                    spanGaps: false,
                    label: "Temperature",
                    value: (u, v) => {
                        return v
                    },
                    stroke: "red",
                    width: 1,
                    dash: [10, 5],
                }
            ],
        }

        const chartEl = document.getElementById("iot-chart");
        chartEl.innerHTML = "";
        new uPlot(opts, [times, vals], chartEl);
    }

    document.addEventListener("DOMContentLoaded", loadChart);
</script>
{{ end }}