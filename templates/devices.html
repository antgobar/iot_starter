{{ define "content" }}
<h1>Your Devices</h1>
<p>Register your devices</p>
<form>
    <div class="field">
        <label for="location" class="label">Location</label>
        <div class="control">
            <input id="location" name="location" class="input" type="text" placeholder="Device location">
        </div>
    </div>
    <div class="field">
        <div class="control">
            <input class="button" type="submit" hx-post="/devices" hx-target="#devices-rows" hx-swap="afterbegin"
                value="Onboard device">
        </div>
    </div>
</form>

{{ if not .Devices }}
<p>You have no devices registered.</p>
{{ else }}
<table class="table is-fullwidth">
    <thead>
        <tr>
            <th>Location</th>
            <th>Date onboarded</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="devices-rows">
        {{ range .Devices }}
        <tr id="device-row-{{ .ID }}">
            <td>{{ .Location }}</td>
            <td>{{ .CreatedAt.Format "2006-01-02 15:04:05" }}</td>
            <td>
                <div class="field is-grouped">
                    <p class="control">
                        <button class="button is-link">View Measurements</button>
                    </p>
                    <p class="control">
                        <!-- Inline onclick handler -->
                        <button class="button is-primary" data-device-id="{{ .ID }}" data-location="{{ .Location }}"
                            onclick="reauthDevice(this)">
                            Regenerate API Key
                        </button>
                    </p>
                    <p class="control">
                        <button class="button is-danger" data-device-id="{{ .ID }}" onclick="offboardDevice(this)">
                            Offboard
                        </button>
                    </p>
                </div>
            </td>
        </tr>
        {{ end }}
    </tbody>
</table>

<div id="reauthModal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-content">
        <div class="box">
            <p id="modalLocation" class="subtitle"></p>
            <label class="label">Your New API Key:</label>
            <div class="field has-addons">
                <div class="control is-expanded">
                    <input id="apiKeyInput" class="input" type="text" readonly>
                </div>
                <div class="control">
                    <button id="copyBtn" class="button">Copy</button>
                </div>
            </div>
            <button id="closeBtn" class="button is-text">Close</button>
        </div>
    </div>
</div>

<script>
    async function offboardDevice(btn) {
        if (!confirm("Are you sure you want to offboard this device? Clicking 'OK' will remove the device from your account.")) {
            return;
        }
        const deviceId = btn.dataset.deviceId;
        const row = document.getElementById(`device-row-${deviceId}`);

        try {
            const resp = await fetch(`/devices/${deviceId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
            })
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            alert('Device offboarded successfully.');
            row.remove();
        } catch (err) {
            console.error('Offboarding failed:', err);
            alert('Could not offboard device. Please try again.');
        }
    }

    async function reauthDevice(btn) {
        const deviceId = btn.dataset.deviceId;
        const location = btn.dataset.location;
        const modal = document.getElementById('reauthModal');
        const apiInput = document.getElementById('apiKeyInput');
        const modalLoc = document.getElementById('modalLocation');

        try {
            const resp = await fetch(`/devices/${deviceId}/reauth`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
            });
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const { apiKey } = await resp.json();

            modalLoc.textContent = `Device at location: ${location}`;
            apiInput.value = apiKey;
            modal.classList.add('is-active');
        } catch (err) {
            console.error('Reauth failed:', err);
            alert('Could not re-authenticate. Please try again.');
        }
    }

    function closeReauthModal() {
        const modal = document.getElementById('reauthModal');
        const apiInput = document.getElementById('apiKeyInput');
        const modalLoc = document.getElementById('modalLocation');

        modal.classList.remove('is-active');
        apiInput.value = '';
        modalLoc.textContent = '';
    }

    // Hook up copy + close + escape â€” needs to run after page load _and_ after HTMX swaps
    function initReauthModalControls() {
        const modalBg = document.querySelector('#reauthModal .modal-background');
        const closeBtn = document.getElementById('closeBtn');
        const copyBtn = document.getElementById('copyBtn');

        // Avoid duplicate listeners
        modalBg.removeEventListener('click', closeReauthModal);
        closeBtn.removeEventListener('click', closeReauthModal);
        document.removeEventListener('keydown', handleEscape);

        // Bind them
        modalBg.addEventListener('click', closeReauthModal);
        closeBtn.addEventListener('click', closeReauthModal);
        copyBtn.addEventListener('click', async () => {
            const apiInput = document.getElementById('apiKeyInput');
            try {
                await navigator.clipboard.writeText(apiInput.value);
                copyBtn.textContent = 'Copied!';
                setTimeout(() => copyBtn.textContent = 'Copy', 1000);
            } catch {
                alert('Unable to copy API key.');
            }
        });

        // Escape key handler
        function handleEscape(e) {
            if (e.key === 'Escape') {
                closeReauthModal();
            }
        }
        document.addEventListener('keydown', handleEscape);
    }

    // Run on full load
    document.addEventListener('DOMContentLoaded', initReauthModalControls);

    // Re-run after HTMX swaps into this fragment
    document.body.addEventListener('htmx:afterSwap', (evt) => {
        // adjust this if your swap target is different
        if (evt.detail.target.id === 'devices-rows' ||
            evt.detail.target.id === 'main-content') {
            initReauthModalControls();
        }
    });
</script>
{{ end }}
{{ end }}